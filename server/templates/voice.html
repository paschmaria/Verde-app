{% extends 'base_dashboard.html' %}
{% load staticfiles %}


{% block body %}
<div class="my-3 my-md-5">
    <div class="container">
        <div class="row">
            <div class="col-md-3">
                <h3 class="page-title mb-5">Voice Calls</h3>
                <div>
                    <div class="list-group list-group-transparent mb-0">
                    <!-- <a href="#" class="list-group-item list-group-item-action d-flex align-items-center active">
                        <span class="icon mr-3"><i class="fe fe-inbox"></i></span>Inbox <span class="ml-auto badge badge-primary">14</span>
                    </a> -->
                    <a href="{% url 'voice-history' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <span class="icon mr-3"><i class="fe fe-send"></i></span>Sent Calls <span class="ml-auto badge badge-secondary">14</span>
                    </a>
                    <a href="{% url 'voice-reports' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <span class="icon mr-3"><i class="fe fe-alert-circle"></i></span>Delivery Reports <span class="ml-auto badge badge-primary">3</span>
                    </a>
                    <a href="{% url 'voice-draft' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <span class="icon mr-3"><i class="fe fe-file"></i></span>Drafts <span class="ml-auto badge badge-secondary">7</span>
                    </a>
                    <a href="{% url 'voice-trash' %}" class="list-group-item list-group-item-action d-flex align-items-center">
                        <span class="icon mr-3"><i class="fe fe-trash-2"></i></span>Trash <span class="ml-auto badge badge-secondary">1</span>
                    </a>
                    </div>
                    <div class="mt-6 mb-6">
                        <a href="{% url 'voice' %}" class="btn btn-secondary btn-block">Make new Voice Call</a>
                    </div>
                </div>
            </div>
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Make new Voice Call</h3>
                    </div>
                    <div class="card-body">
                        <form method="post" action="./voice_upload.php" enctype="multipart/form-data">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <label class="col-sm-2">To:</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="recipients" placeholder="Comma separated phone numbers...">
                                    </div>
                                </div>
                            </div>
                            <script>
                                require(['jquery', 'selectize'], function ($, selectize) {
                                    var REGEX_PHONE = '([0-9]{11}(?: |\-)|(?:\+|00)[0-9]{13}(?: |\-)|((?:[0-9]{2}){4})|((?: |\-)[0-9]{3}(?: |\-)[0-9]{4}))';

                                    $('#recipients').selectize({
                                        persist: false,
                                        maxItems: null,
                                        valueField: 'phone',
                                        labelField: 'name',
                                        searchField: ['name', 'phone'],
                                        options: [
                                            {phone: '08106129023', name: 'Onuorah Paschal'},
                                            {phone: '09098762345', name: 'Nurudeen Dawodu'},
                                            {phone: '08056785432', name: 'Ismail Samson'}
                                        ],
                                        render: {
                                            item: function(item, escape) {
                                                return '<div>' +
                                                    (item.name ? '<span class="name">' + escape(item.name) + '</span>' : '') +
                                                    (item.phone ? '<span class="phone">' + escape(item.phone) + '</span>' : '') +
                                                '</div>';
                                            },
                                            option: function(item, escape) {
                                                var label = item.name;
                                                var caption = item.name ? item.phone : null;
                                                return '<div>' +
                                                    '<span class="label">' + escape(label) + '</span>' +
                                                    (caption ? '<span class="caption">' + escape(caption) + '</span>' : '') +
                                                '</div>';
                                            }
                                        },
                                        createFilter: function(input) {
                                            var match, regex;

                                            // phone
                                            regex = new RegExp('^' + REGEX_PHONE + '$', 'i');
                                            match = input.match(regex);
                                            if (match) return !this.options.hasOwnProperty(match[0]);

                                            // name <phone>
                                            regex = new RegExp('^([^<]*)\<' + REGEX_PHONE + '\>$', 'i');
                                            match = input.match(regex);
                                            if (match) return !this.options.hasOwnProperty(match[2]);

                                            return false;
                                        },
                                        create: function(input) {
                                            if ((new RegExp('^' + REGEX_PHONE + '$', 'i')).test(input)) {
                                                return {phone: input};
                                            }
                                            var match = input.match(new RegExp('^([^<]*)\<' + REGEX_PHONE + '\>$', 'i'));
                                            if (match) {
                                                return {
                                                    phone : match[2],
                                                    name  : $.trim(match[1])
                                                };
                                            }
                                            alert('Invalid Phone Number');
                                            return false;
                                        }
                                    });
                                })
                            </script>
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <label class="col-sm-2">From:</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control">
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="custom-switch">
                                    <input type="checkbox" id="tts-checkbox" name="tts-checkbox" class="custom-switch-input">
                                    <span class="custom-switch-indicator"></span>
                                    <span class="custom-switch-description">Switch between Recording Voice and Uploading Media.</span>
                                </label>
                            </div>
                            <div class="form-group" id="voice" style="display: none;">
                                <label for="deviceLabel">Record Voice message: </label>
                                <canvas class="visualizer"></canvas>
                                <div id="buttons" class="mb-2">
                                    <button type="button" class="btn btn-secondary btn-record">Record</button>
                                    <button type="button" class="btn btn-secondary btn-stop">Stop</button>
                                </div>
                                <div id="soundClip"></div>
                            </div>
                            <div id="media" class="form-group">
                                <div class="custom-file">
                                    <input type="file" class="custom-file-input" name="audio_file">
                                    <label class="custom-file-label">Upload Media file</label>
                                </div>
                            </div>
                            <script>
                                // Toggle handler
                                require(['jquery'], function($){
                                    $(document).ready(function(){
                                    var ttsCheckbox = document.getElementById("tts-checkbox"),
                                            mediaBox = document.getElementById("media"),
                                            voiceBox = document.getElementById("voice");

                                    ttsCheckbox.addEventListener('change', function(e){
                                        if (!e.target.checked) {
                                        mediaBox.style.display = "block";
                                        voiceBox.style.display = "none";
                                        } else {
                                        mediaBox.style.display = "none";
                                        voiceBox.style.display = "block";
                                        }
                                    })
                                    })
                                })
                                
                                // Voice recorder handler
                                var record = document.querySelector('.btn-record'),
                                        stop = document.querySelector('.btn-stop'),
                                    canvas = document.querySelector('.visualizer'),
                                    voiceBox = document.querySelector('#voice'),
                                soundClips = document.querySelector('#soundClip');

                                stop.disabled = true;

                                // visualiser setup - create web audio api context and canvas
                                var audioCtx = new (window.AudioContext || webkitAudioContext)(),
                                    canvasCtx = canvas.getContext("2d");
                                
                                // Record voice
                                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                                    navigator.mediaDevices.getUserMedia ({
                                        // only audio needed
                                        audio: true
                                    }).then(function(stream) {
                                        var mediaRecorder = new MediaRecorder(stream);

                                        visualize(stream);
                                        record.onclick = function() {
                                        mediaRecorder.start();
                                        // console.log(mediaRecorder.state);
                                        // console.log("recorder started");
                                        record.classList.add("btn-danger");
                                        record.classList.remove("btn-secondary");

                                        stop.disabled = false;
                                        record.disabled = true;
                                        }

                                        var message = [];
                                        mediaRecorder.ondataavailable = function(e) {
                                        message.push(e.data);
                                        }

                                        stop.onclick = function() {
                                        mediaRecorder.stop();
                                        // console.log(mediaRecorder.state);
                                        // console.log("recorder stopped");
                                        record.classList.add("btn-secondary");
                                        record.classList.remove("btn-danger");

                                        stop.disabled = true;
                                        record.disabled = false;
                                        }

                                        mediaRecorder.onstop = function(e) {
                                        var messageName = prompt('Enter a name for your message','Weather update'),
                                        messageContainer = document.createElement('div'),
                                            messageLabel = document.createElement('p'),
                                            deleteButton = document.createElement('button'),
                                                    audio = document.createElement('audio');
                                                
                                        messageContainer.classList.add('message');
                                        deleteButton.classList.add("btn", "btn-danger")

                                        function setAttributes(el, attrs) {
                                            for (const key in attrs) {
                                            el.setAttribute(key, attrs[key])
                                            }
                                        }
                                        setAttributes(audio, {"controls" : "", "name" : "recorded_message"})
                                        deleteButton.innerHTML = "Delete";
                                        messageLabel.innerHTML = messageName;

                                        messageContainer.appendChild(audio);
                                        messageContainer.appendChild(messageLabel);
                                        messageContainer.appendChild(deleteButton);
                                        soundClips.appendChild(messageContainer);

                                        var blob = new Blob(message, { 'type' : 'audio/ogg; codecs=opus' }),
                                        audioURL = window.URL.createObjectURL(blob);

                                        message = [];
                                        audio.src = audioURL;
                                        deleteButton.onclick = function(e) {
                                            var eTgt = e.target;
                                            eTgt.parentNode.parentNode.removeChild(eTgt.parentNode);
                                        }
                                        }
                                    }).catch(function(err) {
                                        alert('The following getUserMedia error occured: ' + err);
                                    }
                                    );
                                } else {
                                    alert('Voice Recording not supported on your browser, please upload media file!');
                                }

                                function visualize(stream) {
                                    var source = audioCtx.createMediaStreamSource(stream),
                                    analyser = audioCtx.createAnalyser();
                                    analyser.fftSize = 2048;
                                    var bufferLength = analyser.frequencyBinCount,
                                            dataArray = new Uint8Array(bufferLength);

                                    source.connect(analyser);
                                    //analyser.connect(audioCtx.destination);
                                    draw()
                                    canvas.width = 200;
                                    function draw() {
                                    var WIDTH = canvas.width,
                                        HEIGHT = canvas.height;
                                    // console.log(WIDTH)
                                    requestAnimationFrame(draw);
                                    analyser.getByteTimeDomainData(dataArray);

                                    canvasCtx.fillStyle = 'rgb(200, 200, 200)';
                                    canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);
                                    canvasCtx.lineWidth = 2;
                                    canvasCtx.strokeStyle = 'rgb(0, 0, 0)';
                                    canvasCtx.beginPath();

                                    var sliceWidth = WIDTH * 1.0 / bufferLength,
                                                    x = 0;

                                    for(var i = 0; i < bufferLength; i++) {   
                                        var v = dataArray[i] / 128.0;
                                        var y = v * HEIGHT/2;

                                        if(i === 0) {
                                        canvasCtx.moveTo(x, y);
                                        } else {
                                        canvasCtx.lineTo(x, y);
                                        }

                                        x += sliceWidth;
                                    }

                                    canvasCtx.lineTo(canvas.width, canvas.height/2);
                                    canvasCtx.stroke();
                                    }
                                }

                                window.onresize = function() {
                                    canvas.width = voiceBox.offsetWidth;
                                }

                                window.onresize();
                            </script>
                            <div class="btn-list mt-4 text-right">
                                <button type="button" class="btn btn-secondary btn-space">Save as Draft</button>
                                <button type="submit" class="btn btn-primary btn-space">Send message</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}